version: 2.1

executors:
  my-executor:
    docker:
      - image: circleci/node:14
        environment:
          CI: "true"
    working_directory: ~/workdir

jobs:
  install:
    executor: my-executor
    steps:
      - checkout

      - restore_cache:
          name: restore .yarn/cache
          keys:
            - yarn-v2-cache-{{ arch }}
      - restore_cache:
          name: restore node_modules
          keys:
            - node-modules-v2-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - node-modules-v2-{{ arch }}-{{ .Branch }}
            - node-modules-v2-{{ arch }}

      - run: yarn install --immutable

      - save_cache:
          name: cache .yarn/cache
          key: yarn-v2-cache-{{ arch }}
          paths:
            - .yarn/cache
      - save_cache:
          name: cache node_modules
          key: node-modules-v2-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - node_modules

      - persist_to_workspace:
          root: .
          paths:
            - ./*

  lib-site-build:
    executor: my-executor
    steps:
      - attach_workspace:
          at: .
      - run: yarn lib:build && yarn lib:build-docs && yarn site:build
      - persist_to_workspace:
          root: .
          paths:
            - ./*

  lib-test:
    executor: my-executor
    steps:
      - attach_workspace:
          at: .
      - run: yarn lib:test -i --coverage
      - persist_to_workspace:
          root: .
          paths:
            - packages/lib/coverage/*

  # upload coverage
  upload-coverage:
    executor: my-executor
    steps:
      - attach_workspace:
          at: .

      # only run coverage if the token is present (it is not present for fork PRs for security reasons)
      - run:
          name: upload coverage
          command: |
            if [[ -v CODECOV_TOKEN ]]
            then
                yarn codecov -p ./packages/lib
                echo "Coverage info uploaded"
            else
                echo "Warning - Coverage info could NOT be uploaded since the CODECOV_TOKEN was not available"
            fi
workflows:
  version: 2
  full-workflow:
    jobs:
      - install
      - lib-site-build:
          requires:
            - install
      - lib-test:
          requires:
            - install
      - upload-coverage:
          requires:
            - lib-test
